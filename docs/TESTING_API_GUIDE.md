# 测试API使用指南

## 重要提醒 ⚠️

**测试系统已经配置了专门的测试API，请不要使用外部API密钥！**

## 测试API配置

本项目的测试系统已经内置了模拟API客户端，专门用于测试环境：

### 1. 自动测试API配置

运行测试时，系统会自动使用内置的测试API：

```bash
# 运行所有测试 - 自动使用测试API
pytest

# 运行特定测试
pytest tests/test_real_integration.py::TestSystemPerformanceIntegration::test_high_frequency_interactions
```

### 2. 测试配置文件

测试系统使用 `tests/fixtures.py` 中的配置：

```python
@pytest.fixture
def test_config():
    """测试配置 - 使用内置测试API"""
    return TestConfig(
        api_key="test-api-key-for-internal-testing",  # 内置测试密钥
        test_mode=True,
        mock_api=True
    )
```

### 3. 性能测试说明

性能测试 (`test_high_frequency_interactions`) 的设计要求：

- **平均响应时间**: < 0.5秒/次交互
- **API调用率**: < 10%（大部分操作使用内部逻辑）
- **执行模式**: `internal_first` - 优先使用内部逻辑，减少API调用

### 4. 测试API特点

内置测试API具有以下特点：

1. **零网络延迟**: 完全本地模拟
2. **确定性响应**: 相同输入产生相同输出
3. **性能优化**: 专为高频测试设计
4. **错误模拟**: 可以模拟各种API错误情况

## 常见问题

### Q: 为什么会出现 "Invalid token" 错误？

A: 这通常是因为：
1. 使用了外部API密钥而不是测试API
2. 测试配置没有正确加载
3. 混合了开发环境和测试环境的配置

**解决方案**: 确保运行测试时使用pytest，它会自动加载正确的测试配置。

### Q: 性能测试失败怎么办？

A: 性能测试失败的常见原因：
1. **API调用过多**: 检查是否正确使用了 `internal_first` 模式
2. **网络延迟**: 确保使用测试API而不是外部API
3. **硬件性能**: 在较慢的机器上可能需要调整性能阈值

### Q: 如何调试测试问题？

A: 使用调试模式运行测试：

```bash
# 详细输出模式
pytest -v -s tests/test_real_integration.py

# 只运行失败的测试
pytest --lf

# 生成测试报告
pytest --html=report.html
```

## 开发vs测试环境

| 环境 | API类型 | 用途 | 性能要求 |
|------|---------|------|----------|
| 开发环境 | 外部API | 真实功能验证 | 较宽松 |
| 测试环境 | 内置测试API | 自动化测试 | 严格 |
| 生产环境 | 生产API | 实际服务 | 最严格 |

## 最佳实践

1. **测试隔离**: 测试环境完全独立，不依赖外部服务
2. **性能基准**: 使用固定的性能基准，确保测试结果可重复
3. **错误处理**: 测试各种错误情况，包括API失败的优雅降级
4. **资源清理**: 每个测试后自动清理资源，避免测试间干扰

## 故障排除

如果仍然遇到API相关问题，请检查：

1. **环境变量**: 确保没有设置外部API密钥的环境变量
2. **配置文件**: 检查是否有本地配置文件覆盖了测试配置
3. **网络连接**: 测试应该完全离线运行
4. **依赖版本**: 确保所有依赖都是测试兼容的版本

---

**记住**: 测试系统的设计目标是快速、可靠、可重复。使用内置测试API是实现这些目标的关键！
