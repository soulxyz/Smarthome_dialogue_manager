
# æ™ºèƒ½å®¶å±…å¯¹è¯ç³»ç»Ÿæµ‹è¯•æŒ‡å—

æœ¬é¡¹ç›®é‡‡ç”¨äº†å…¨æ–°çš„çœŸå®žæµ‹è¯•ç­–ç•¥ï¼Œå½»åº•ç§»é™¤äº†åŽŸæœ‰çš„ä¸ºäº†æµ‹è¯•è€Œæµ‹è¯•çš„å‡ä»£ç ï¼Œå»ºç«‹äº†åŸºäºŽçœŸå®žç»„ä»¶å’Œåœºæ™¯çš„æµ‹è¯•ä½“ç³»ã€‚

## ðŸŽ¯ æµ‹è¯•ç†å¿µ

### æµ‹è¯•åˆ†ç±»ç­–ç•¥

æˆ‘ä»¬æ ¹æ®APIæ¶ˆè€—æˆæœ¬å°†æµ‹è¯•åˆ†ä¸ºä¸¤ç±»ï¼š

1. **éœ€è¦API_KEYçš„æµ‹è¯•** - è¿›è¡Œå¿…è¦çš„åŠŸèƒ½æµ‹è¯•ï¼Œé¿å…è¿‡åº¦æ¶ˆè€—
2. **å†…éƒ¨é€»è¾‘æµ‹è¯•** - å¯ä»¥è¿›è¡ŒåŽ‹åŠ›æµ‹è¯•å’Œå¤§é‡æµ‹è¯•

### æ‘’å¼ƒçš„æ—§æ¨¡å¼

âŒ **FakeAPIClient** - å®Œå…¨è„±ç¦»çœŸå®žAPIé€»è¾‘  
âŒ **FakeMemoryManager** - ç»•è¿‡çœŸå®žæ•°æ®å­˜å‚¨  
âŒ **ç¡¬ç¼–ç æµ‹è¯•æ•°æ®** - ä¸èƒ½åæ˜ çœŸå®žä½¿ç”¨åœºæ™¯  
âŒ **Mockä¸€åˆ‡** - æµ‹è¯•å˜æˆè‡ªæˆ‘æ¬ºéª—  

âœ… **çœŸå®žç»„ä»¶** - ä½¿ç”¨å®žé™…çš„APIå®¢æˆ·ç«¯å’Œæ•°æ®åº“  
âœ… **çœŸå®žåœºæ™¯** - æµ‹è¯•ç”¨æˆ·å®žé™…ä¼šé‡åˆ°çš„æƒ…å†µ  
âœ… **æ™ºèƒ½åˆ†ç±»** - APIæµ‹è¯•èŠ‚çº¦ä½¿ç”¨ï¼Œå†…éƒ¨é€»è¾‘å¯ä»¥åŽ‹åŠ›æµ‹è¯•  
âœ… **é…ç½®ç®¡ç†** - å®‰å…¨çš„APIå¯†é’¥ç®¡ç†  

## ðŸ”§ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# å®‰è£…åŸºç¡€ä¾èµ–
make install

# å®‰è£…å¼€å‘ä¾èµ–
make install-dev
```

### 2. è®¾ç½®APIå¯†é’¥

```bash
# äº¤äº’å¼è®¾ç½®
make setup-api-key

# æˆ–æ‰‹åŠ¨åˆ›å»º
echo "your-api-key-here" > tests/.api_key
```

### 3. è¿è¡Œæµ‹è¯•

```bash
# æŽ¨èï¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆè·³è¿‡æ…¢é€Ÿæµ‹è¯•ï¼‰
make test

# åªè¿è¡Œå†…éƒ¨é€»è¾‘æµ‹è¯•ï¼ˆä¸æ¶ˆè€—APIï¼‰
make test-internal

# è¿è¡ŒAPIæµ‹è¯•ï¼ˆä¼šæ¶ˆè€—APIè°ƒç”¨ï¼‰
make test-api

# è¿è¡Œé›†æˆæµ‹è¯•
make test-integration
```

## ðŸ“ æµ‹è¯•æ–‡ä»¶ç»“æž„

### æ–°çš„æµ‹è¯•æ–‡ä»¶

```
tests/
â”œâ”€â”€ config.py                    # æµ‹è¯•é…ç½®ç®¡ç†
â”œâ”€â”€ fixtures.py                  # çœŸå®žæµ‹è¯•å¤¹å…·
â”œâ”€â”€ conftest.py                  # pytesté…ç½®
â”œâ”€â”€ test_real_unit.py            # çœŸå®žå•å…ƒæµ‹è¯•
â”œâ”€â”€ test_real_device_manager.py  # è®¾å¤‡ç®¡ç†å™¨æµ‹è¯•
â”œâ”€â”€ test_real_dialogue.py        # å¯¹è¯ç³»ç»Ÿæµ‹è¯•
â”œâ”€â”€ test_real_focus_and_omission.py  # ç„¦ç‚¹å’Œçœç•¥æ¶ˆè§£æµ‹è¯•
â”œâ”€â”€ test_real_edge_cases.py      # è¾¹ç•Œæ¡ä»¶æµ‹è¯•
â””â”€â”€ test_real_integration.py     # é›†æˆæµ‹è¯•
```

### é…ç½®æ–‡ä»¶

- `tests/.api_key` - APIå¯†é’¥æ–‡ä»¶ï¼ˆè¢«gitignoreï¼‰
- `tests/.gitignore` - æµ‹è¯•ä¸“ç”¨å¿½ç•¥æ–‡ä»¶
- `pytest.ini` - pytesté…ç½®
- `requirements-dev.txt` - å¼€å‘ä¾èµ–

## ðŸŽ® æµ‹è¯•å‘½ä»¤è¯¦è§£

### åŸºç¡€æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆæŽ¨èæ—¥å¸¸ä½¿ç”¨ï¼‰
make test                    # è·³è¿‡æ…¢é€Ÿæµ‹è¯•ï¼ŒèŠ‚çº¦API

# å®Œæ•´æµ‹è¯•ï¼ˆè°¨æ…Žä½¿ç”¨ï¼‰
make test-all               # åŒ…æ‹¬æ‰€æœ‰æ…¢é€Ÿæµ‹è¯•ï¼Œå¤§é‡APIæ¶ˆè€—

# æŒ‰ç±»åž‹è¿è¡Œ
make test-unit              # å•å…ƒæµ‹è¯•
make test-integration       # é›†æˆæµ‹è¯•
make test-internal          # å†…éƒ¨é€»è¾‘ï¼ˆä¸æ¶ˆè€—APIï¼‰
make test-api              # APIæµ‹è¯•ï¼ˆæ¶ˆè€—APIï¼‰
```

### ç‰¹å®šæ¨¡å—æµ‹è¯•

```bash
make test-device-manager    # è®¾å¤‡ç®¡ç†å™¨
make test-dialogue-engine   # å¯¹è¯å¼•æ“Ž
make test-focus-omission    # ç„¦ç‚¹å’Œçœç•¥æ¶ˆè§£
make test-edge-cases        # è¾¹ç•Œæ¡ä»¶
make test-integration-scenarios  # é›†æˆåœºæ™¯
```

### æ€§èƒ½å’Œåˆ†æž

```bash
make test-performance       # æ€§èƒ½æµ‹è¯•
make coverage              # è¦†ç›–çŽ‡æŠ¥å‘Š
make test-stats            # APIä½¿ç”¨ç»Ÿè®¡
make performance-report     # æ€§èƒ½æŠ¥å‘Š
```

### å¼€å‘è¾…åŠ©

```bash
make quick-test            # å¿«é€Ÿæµ‹è¯•ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
make debug-test            # è°ƒè¯•æ¨¡å¼
make validate              # éªŒè¯æ ¸å¿ƒåŠŸèƒ½
make check-env             # æ£€æŸ¥æµ‹è¯•çŽ¯å¢ƒ
```

## ðŸ·ï¸ æµ‹è¯•æ ‡è®°ç³»ç»Ÿ

### æµ‹è¯•ç±»åž‹æ ‡è®°

- `@pytest.mark.unit` - å•å…ƒæµ‹è¯•
- `@pytest.mark.integration` - é›†æˆæµ‹è¯•
- `@pytest.mark.api_required` - éœ€è¦çœŸå®žAPI
- `@pytest.mark.internal_logic` - å†…éƒ¨é€»è¾‘ï¼ˆå¯åŽ‹åŠ›æµ‹è¯•ï¼‰
- `@pytest.mark.slow` - æ…¢é€Ÿæµ‹è¯•

### åŠŸèƒ½æ¨¡å—æ ‡è®°

- `@pytest.mark.device_manager` - è®¾å¤‡ç®¡ç†å™¨
- `@pytest.mark.dialogue_system` - å¯¹è¯ç³»ç»Ÿ
- `@pytest.mark.focus_management` - ç„¦ç‚¹ç®¡ç†
- `@pytest.mark.edge_cases` - è¾¹ç•Œæ¡ä»¶

### ä½¿ç”¨ç¤ºä¾‹

```python
@pytest.mark.internal_logic
def test_device_operations_stress():
    """å†…éƒ¨é€»è¾‘åŽ‹åŠ›æµ‹è¯• - å¯ä»¥å¤§é‡è¿è¡Œ"""
    pass

@pytest.mark.api_required
@pytest.mark.skipif(not pytest.config.getoption("--use-real-api"), 
                   reason="è·³è¿‡çœŸå®žAPIæµ‹è¯•")
def test_real_dialogue_with_api():
    """çœŸå®žAPIæµ‹è¯• - èŠ‚çº¦ä½¿ç”¨"""
    pass
```

## ðŸ“Š æµ‹è¯•ç±»åž‹è¯¦è§£

### 1. å†…éƒ¨é€»è¾‘æµ‹è¯•ï¼ˆå¯åŽ‹åŠ›æµ‹è¯•ï¼‰

è¿™ç±»æµ‹è¯•ä¸æ¶ˆè€—APIè°ƒç”¨ï¼Œå¯ä»¥è¿›è¡Œå¤§é‡åŽ‹åŠ›æµ‹è¯•ï¼š

- **è®¾å¤‡çŠ¶æ€ç®¡ç†** - 1000ä¸ªè®¾å¤‡çš„åˆ›å»ºã€æ“ä½œã€æŸ¥è¯¢
- **ç„¦ç‚¹å®žä½“ç®¡ç†** - 500æ¬¡ç„¦ç‚¹åˆ‡æ¢å’Œè¡°å‡
- **å¹¶å‘æ“ä½œ** - å¤šçº¿ç¨‹è®¾å¤‡æŽ§åˆ¶
- **å†…å­˜ç®¡ç†** - å¤§é‡æ•°æ®çš„åˆ›å»ºå’Œæ¸…ç†
- **é”™è¯¯æ¢å¤** - å„ç§å¼‚å¸¸æƒ…å†µçš„å¤„ç†

```python
def test_device_creation_stress():
    """åˆ›å»º1000ä¸ªè®¾å¤‡ï¼ŒéªŒè¯æ€§èƒ½"""
    for i in range(1000):
        device = LightDevice(f"ç¯{i}", f"æˆ¿é—´{i//20}")
        # éªŒè¯æ€§èƒ½æŒ‡æ ‡
```

### 2. APIé›†æˆæµ‹è¯•ï¼ˆå¿…è¦åŠŸèƒ½æµ‹è¯•ï¼‰

è¿™ç±»æµ‹è¯•ä¼šæ¶ˆè€—APIè°ƒç”¨ï¼Œåªè¿›è¡Œå¿…è¦çš„åŠŸèƒ½éªŒè¯ï¼š

- **åŸºç¡€å¯¹è¯æµç¨‹** - æ¯ç§æ„å›¾æµ‹è¯•ä¸€æ¬¡
- **é”™è¯¯å¤„ç†** - APIå¤±è´¥æ—¶çš„é™çº§æœºåˆ¶
- **æ¾„æ¸…åŠŸèƒ½** - æ¨¡ç³Šè¾“å…¥çš„å¤„ç†
- **ç„¦ç‚¹è¿½è¸ª** - çœŸå®žå¯¹è¯ä¸­çš„ç„¦ç‚¹ç®¡ç†

```python
@pytest.mark.api_required
def test_basic_dialogue_flow(api_tracker):
    """åŸºç¡€å¯¹è¯æµç¨‹ - èŠ‚çº¦APIä½¿ç”¨"""
    essential_tests = [
        ("ä½ å¥½", "greeting"),
        ("æ‰“å¼€å®¢åŽ…çš„ç¯", "device_control"),
        ("çŽ°åœ¨æ¸©åº¦æ€Žä¹ˆæ ·", "query_status"),
    ]
    # åªæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½
```

## ðŸ”§ é…ç½®ç®¡ç†

### APIå¯†é’¥ç®¡ç†

```python
# tests/config.py
class TestConfig:
    api_key: str                 # APIå¯†é’¥
    use_real_api: bool = True    # æ˜¯å¦ä½¿ç”¨çœŸå®žAPI
    api_timeout: int = 30        # APIè¶…æ—¶æ—¶é—´
    max_concurrent_requests: int = 5  # æœ€å¤§å¹¶å‘è¯·æ±‚
```

### çŽ¯å¢ƒå˜é‡

```bash
# è·³è¿‡APIæµ‹è¯•
export USE_REAL_API=false

# ä½¿ç”¨å†…å­˜æ•°æ®åº“
export USE_IN_MEMORY_DB=true

# è®¾ç½®APIè¶…æ—¶
export API_TIMEOUT=60
```

## ðŸ“ˆ æ€§èƒ½åŸºå‡†

### å†…éƒ¨é€»è¾‘æ€§èƒ½ç›®æ ‡

- **è®¾å¤‡æ“ä½œ**: >50æ¬¡/ç§’
- **æ„å›¾è¯†åˆ«**: >100æ¬¡/ç§’  
- **ç„¦ç‚¹ç®¡ç†**: >200æ¬¡/ç§’
- **çŠ¶æ€æŸ¥è¯¢**: >500æ¬¡/ç§’

### APIè°ƒç”¨æ•ˆçŽ‡ç›®æ ‡

- **è®¾å¤‡æŽ§åˆ¶åœºæ™¯**: <0.5æ¬¡APIè°ƒç”¨/æ“ä½œ
- **å®Œæ•´å¯¹è¯åœºæ™¯**: <1æ¬¡APIè°ƒç”¨/è½®æ¬¡
- **é›†æˆæµ‹è¯•**: <20æ¬¡APIè°ƒç”¨/åœºæ™¯

## ðŸš€ æŒç»­é›†æˆ

### GitHub Actionså·¥ä½œæµ

1. **å†…éƒ¨é€»è¾‘æµ‹è¯•** - åœ¨æ‰€æœ‰Pythonç‰ˆæœ¬ä¸Šè¿è¡Œ
2. **å•å…ƒæµ‹è¯•** - å¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½
3. **æ€§èƒ½æµ‹è¯•** - ç¡®ä¿æ€§èƒ½ä¸é™çº§
4. **ä»£ç è´¨é‡** - æ ¼å¼æ£€æŸ¥å’Œå®‰å…¨æ‰«æ
5. **APIé›†æˆæµ‹è¯•** - ä»…åœ¨æœ‰APIå¯†é’¥æ—¶è¿è¡Œ

### æœ¬åœ°å¼€å‘æµç¨‹

```bash
# å¼€å‘æ—¶å¿«é€ŸéªŒè¯
make quick-test

# æäº¤å‰å®Œæ•´æ£€æŸ¥
make test
make lint
make coverage

# å‘å¸ƒå‰å®Œæ•´éªŒè¯
make validate
```

## ðŸ” æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

1. **APIå¯†é’¥æœªè®¾ç½®**
   ```bash
   make setup-api-key
   # æˆ–æ‰‹åŠ¨åˆ›å»º tests/.api_key
   ```

2. **æ•°æ®åº“æƒé™é—®é¢˜**
   ```bash
   # æ¸…ç†æ—§æ•°æ®åº“æ–‡ä»¶
   make clean
   # ä½¿ç”¨å†…å­˜æ•°æ®åº“
   export USE_IN_MEMORY_DB=true
   ```

3. **æµ‹è¯•è¶…æ—¶**
   ```bash
   # è·³è¿‡æ…¢é€Ÿæµ‹è¯•
   make test --skip-slow
   # å¢žåŠ è¶…æ—¶æ—¶é—´
   export API_TIMEOUT=60
   ```

4. **å¹¶å‘å†²çª**
   ```bash
   # å•çº¿ç¨‹è¿è¡Œ
   pytest -v
   # è€Œä¸æ˜¯ pytest -n auto
   ```

### è°ƒè¯•æŠ€å·§

```bash
# å•ä¸ªæµ‹è¯•è°ƒè¯•
pytest tests/test_real_device_manager.py::test_specific_function -v -s

# ä½¿ç”¨pdbè°ƒè¯•
make debug-test

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pytest --log-cli-level=DEBUG -v

# æ€§èƒ½åˆ†æž
make profile-test
```

## ðŸ“š æœ€ä½³å®žè·µ

### ç¼–å†™æ–°æµ‹è¯•

1. **é€‰æ‹©åˆé€‚çš„æµ‹è¯•ç±»åž‹**
   - å†…éƒ¨é€»è¾‘ â†’ å¯ä»¥åŽ‹åŠ›æµ‹è¯•
   - éœ€è¦API â†’ æœ€å°åŒ–è°ƒç”¨

2. **ä½¿ç”¨çœŸå®žç»„ä»¶**
   ```python
   # âœ… å¥½çš„åšæ³•
   def test_with_real_components(device_manager, api_client):
       result = device_manager.perform_action("æ‰“å¼€", "ç¯", "å®¢åŽ…")
       assert result["success"]
   
   # âŒ é¿å…çš„åšæ³•
   def test_with_fake_components():
       fake_manager = FakeDeviceManager()
       # ...
   ```

3. **åˆç†ä½¿ç”¨æ ‡è®°**
   ```python
   @pytest.mark.internal_logic  # å¯ä»¥åŽ‹åŠ›æµ‹è¯•
   @pytest.mark.device_manager  # åŠŸèƒ½åˆ†ç±»
   def test_device_operations():
       pass
   ```

4. **æ¸…ç†èµ„æº**
   ```python
   def test_with_cleanup(temp_db_path):
       # æµ‹è¯•ä»£ç 
       pass  # temp_db_pathè‡ªåŠ¨æ¸…ç†
   ```

### æ€§èƒ½è€ƒè™‘

- **å†…éƒ¨æµ‹è¯•**: è¿½æ±‚é«˜è¦†ç›–çŽ‡å’ŒåŽ‹åŠ›æµ‹è¯•
- **APIæµ‹è¯•**: è¿½æ±‚å…³é”®è·¯å¾„è¦†ç›–
- **é›†æˆæµ‹è¯•**: è¿½æ±‚çœŸå®žåœºæ™¯æ¨¡æ‹Ÿ
- **è¾¹ç•Œæµ‹è¯•**: è¿½æ±‚å¼‚å¸¸æƒ…å†µå¤„ç†

## ðŸ“– ç›¸å…³æ–‡æ¡£

- [APIå®¢æˆ·ç«¯æ–‡æ¡£](../dialogue_manager/api_client.py)
- [è®¾å¤‡ç®¡ç†å™¨æ–‡æ¡£](../dialogue_manager/device_manager.py)
- [å¯¹è¯å¼•æ“Žæ–‡æ¡£](../dialogue_manager/engine.py)
- [é¡¹ç›®README](../README.md)

---

é€šè¿‡è¿™å¥—çœŸå®žæµ‹è¯•ä½“ç³»ï¼Œæˆ‘ä»¬ç¡®ä¿äº†ä»£ç è´¨é‡çš„åŒæ—¶ï¼Œä¹Ÿå»ºç«‹äº†å¯æŒç»­çš„æµ‹è¯•å®žè·µï¼Œè®©æµ‹è¯•çœŸæ­£ä¸ºäº§å“è´¨é‡æœåŠ¡ï¼Œè€Œä¸æ˜¯ä¸ºäº†æµ‹è¯•è€Œæµ‹è¯•ã€‚
